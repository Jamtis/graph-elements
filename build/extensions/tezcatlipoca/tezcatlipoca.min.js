define(["exports","module","../../graph","../../../node_modules/d3/d3","../../external/mixin","../../external/layer","../../external/requestAnimationFunction"],function(a,b,c,d,e,f,g){"use strict";function h(a){var b={UI:{circle:{radius:6},arrow:{width:5.5,ratio:2},size:{ratio:2,offset:{x:0,y:0}}},d3:{force:{charge:-200,linkDistance:30,linkStrength:1,gravity:.15,enabled:!0,start:function(){if(a.config.d3.force.enabled){var b=a.force;b.start(),b.alpha(.1)}}}},state:{mode:"default",selected:void 0}},c={UI:{circle:{radius:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=parseFloat(b),1/0>b&&b>-(1/0)&&(c(b),a.force.stop(),a.config.d3.force.start())})}},arrow:{width:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=parseFloat(b),1/0>b&&b>-(1/0)&&(c(b),a.force.stop(),a.config.d3.force.start())})},ratio:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=Math.abs(parseFloat(b)),1/0>b&&(c(b),a.force.stop(),a.config.d3.force.start())})}},size:{ratio:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=Math.max(A,parseFloat(b)),1/0>b&&(c(b),a.resize())})},offset:{x:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=parseFloat(b),1/0>b&&b>-(1/0)&&(c(b),a.resize())})},y:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=parseFloat(b),1/0>b&&b>-(1/0)&&(c(b),a.resize())})}}}},d3:{force:{charge:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=parseFloat(b),1/0>b&&b>-(1/0)&&(c(b),a.force.charge(b).stop(),a.config.d3.force.start())})},linkDistance:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){if(b=Math.max(0,parseFloat(b)),1/0>b){var d=getComputedStyle(a.svg),e=d.width,f=d.height;c(b),a.force.linkDistance(2e3*b/Math.hypot(parseFloat(e),parseFloat(f))).stop(),a.config.d3.force.start()}})},linkStrength:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=Math.max(0,parseFloat(b)),1/0>b&&(c(b),a.force.linkStrength(b).stop(),a.config.d3.force.start())})},gravity:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=Math.max(0,parseFloat(b)),1/0>b&&(c(b),a.force.gravity(b).stop(),a.config.d3.force.start())})},enabled:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){c(!!b),b?a.force.start():a.force.stop()})}}},state:{mode:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=-1!=["default","edit"].indexOf(b)?b:"default",a.setAttribute("mode",b),a.dispatchEvent(new CustomEvent("modechange",{detail:b})),c(b)})},selected:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){console.log("select",b);var d=a[v].selectAll("circle.node"),e=d.filter(function(a){return b===a.index}).node();d.each(function(){this!==e&&this.classList.remove("selected")}),e?(e.classList.add("selected"),c(b),a.dispatchEvent(new CustomEvent("select",{detail:{circle:e,datum:e.__data__}}))):(a.config.state.mode="default",c(void 0),a.dispatchEvent(new CustomEvent("deselect")))})}}};a[t]=q(b,c)}function i(a){a[u]={},a[v]=o.select(a.svg);var b=o.layout.force();a[s]=b,b.on("tick",a[y]),b.size([z,z]),a.resize(),addEventListener("polymer-ready",a[x])}function j(a){a[x]=r(function(){var b=a.svg,c=getComputedStyle(b),d=c.width,e=c.height,f=a.config.UI.size.ratio;d=parseFloat(d)/f,e=parseFloat(e)/f,p(b.viewBox.baseVal,{x:-d/2,y:-e/2,width:d,height:e},p.OVERRIDE),a.config.d3.force.linkDistance+=0,a.config.d3.force.start(),a.draw()}),a[y]=function(){var b=a.svg.viewBox.baseVal,c=b.x,d=b.y,e=b.width,f=b.height,g=a.config.UI.size.offset,h=a.config.UI.size.ratio;c=c*h+g.x,d=d*h+g.y,e*=h/z,f*=h/z;var i=a.config.UI.arrow,j=a[u],k=j.circles,l=j.paths;k&&k.attr("transform",function(a){return"translate("+(a.x*e+c)+","+(a.y*f+d)+")"}),l&&l.attr("d",function(a){var b=a.source,g=a.target,h=b.x*e+c,j=b.y*f+d,k=g.x*e+c,l=g.y*f+d,m=h-k,n=j-l,o=Math.hypot(m,n),p=m/o*i.width,q=n/o*i.width;isNaN(p)&&(p=0),isNaN(q)&&(q=0);var r=h-p*i.ratio,s=j-q*i.ratio;return"M"+k+","+l+"L "+r+","+s+"L "+(h+q)+","+(j-p)+"L "+(h-q)+","+(j+p)+"L "+r+","+s})};var b=q(a.config.UI.size,{ratio:{translate:function(b){console.log("ratio",b),a.resize()},duration:280},offset:{x:{translate:function(b){console.log("x",b),a.resize()}},y:{translate:function(b){console.log("y",b),a.resize()}}}});a.svg.addEventListener("wheel",function(a){var c=(a.layerX,a.layerY,a.wheelDelta);b.ratio=Math.max(0,b.ratio+c/20)}),PolymerGestures.addEventListener(a.svg,"tap",function(b){console.log("tap"),b.bubbles=!1,b.srcElement===a.svg&&(a[v].selectAll("circle.node").each(function(){this.classList.remove("selected")}),a.config.state.selected=void 0)}),!function(){var c=void 0,d=void 0;PolymerGestures.addEventListener(a.svg,"pinch",function(a){var e=a.scale,f=a.preventTap;f(),void 0!==d&&(b.ratio=Math.max(0,b.ratio+2*(e-d)),clearTimeout(c),c=setTimeout(function(){d=void 0},1e3)),d=e})}(),PolymerGestures.addEventListener(a.svg,"track",function(b){if(console.log("track"),b.bubbles=!1,b.srcElement===a.svg){var c=a.config.UI.size.ratio;a.config.UI.size.offset.x+=b.ddx/c,a.config.UI.size.offset.y+=b.ddy/c}}),!function(){var b=void 0;PolymerGestures.addEventListener(a.svg,"hold",function(c){console.log("hold"),c.bubbles=!1,c.preventTap(),c.srcElement===a.svg&&(b=!1)}),PolymerGestures.addEventListener(a.svg,"holdpulse",function(c){var d=(c.x,c.y,c.srcElement),e=c.holdTime;console.log("holdpulse"),event.bubbles=!1,d===a.svg&&e>800&&!b&&(b=!0,console.log("add node"),a.graph.addNode({}),a.updateGraph())})}()}function k(a,b){console.log("entering circles",b),b.each(function(b,c){PolymerGestures.addEventListener(this,"tap",function(b){console.log("tap on node"),b.bubbles=!1,"edit"==a.config.state.mode||(a.config.state.selected=c)}),PolymerGestures.addEventListener(this,"trackstart",function(a){a.preventTap(),a.bubbles=!1,b.fixed=!0}),PolymerGestures.addEventListener(this,"track",function(c){c.bubbles=!1;var d=a.toNodeCoordinates(c.ddx,c.ddy),e=d.x,f=d.y;b.px=b.x+=e,b.py=b.y+=f,a.draw()}),PolymerGestures.addEventListener(this,"trackend",function(a){a.bubbles=!1,b.fixed=!1}),PolymerGestures.addEventListener(this,"hold",function(b){console.log("hold on node"),b.bubbles=!1,b.preventTap(),a.config.state.selected=c,a.config.state.mode="edit"})})}var l=function(a){return a&&a.__esModule?a["default"]:a},m=function(a,b){if(Array.isArray(a))return a;if(Symbol.iterator in Object(a)){for(var c,d=[],e=a[Symbol.iterator]();!(c=e.next()).done&&(d.push(c.value),!b||d.length!==b););return d}throw new TypeError("Invalid attempt to destructure non-iterable instance")},n=c.Graph,o=l(d),p=l(e),q=l(f),r=l(g),s=Symbol(),t=Symbol(),u=Symbol(),v=Symbol(),w=Symbol(),x=Symbol(),y=Symbol(),z=1e3,A=.35;b.exports=Object.defineProperties({is:"graphjs-tezcatlipoca",created:function(){h(this)},ready:function(){j(this),i(this),p(this.config,this.config,p.OVERRIDE)},attached:function(){addEventListener("resize",this[x])},detached:function(){removeEventListener("resize",this[x])},draw:function(){this[y]()},resize:function(){this[x]()},updateGraph:function(){var a=this;console.log("update graph"),this.graph?!function(){var b=new Map(function(){var b=[],c=!0,d=!1,e=void 0;try{for(var f,g=a.graph.nodes[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=m(f.value,1),i=h[0];b.push([i,{value:i}])}}catch(j){d=!0,e=j}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}return b}()),c=function(){var a=[],c=!0,d=!1,e=void 0;try{for(var f,g=b[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=m(f.value,2),i=h[1];a.push(i)}}catch(j){d=!0,e=j}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}return a}(),d=function(){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a.graph.edges[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=g.value,j=i.source,k=i.target;c.push({source:b.get(j),target:b.get(k)})}}catch(l){e=!0,f=l}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}(),e=a.force;e.nodes(c).links(d);var f=a[v],g=f.selectAll("circle.node").data(c),h=f.selectAll("path.edge").data(d);a[u]={circles:g,paths:h},h.enter().append("path").attr("class","edge");var i=g.enter().append("circle").attr("r",a.config.UI.circle.radius).attr("class","node");k(a,i),h.exit().remove(),g.exit().remove(),f.selectAll("circle.node,path.edge").sort(function(a){return("value"in a)-.5}),e.start();for(var j=0;10>j;++j)e.tick();e.alpha(0),a.config.d3.force.start()}():this.graph=new n},toNodeCoordinates:function(a,b){{var c=getComputedStyle(this.svg),d=c.width,e=c.height,f=this.config.UI.size.ratio;this.svg.viewBox.baseVal}return{x:a/parseFloat(d)/f*z,y:b/parseFloat(e)/f*z}}},{svg:{get:function(){return this.$.svg},configurable:!0,enumerable:!0},force:{get:function(){return this[s]},configurable:!0,enumerable:!0},config:{get:function(){return this[t]},set:function(a){p(this[t],a,p.OVERRIDE)},configurable:!0,enumerable:!0},graph:{get:function(){return this[w]},set:function(a){this[w]=a,this.updateGraph()},configurable:!0,enumerable:!0}})});