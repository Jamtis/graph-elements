define(["exports","module","../../graph","../../../node_modules/d3/d3","../../external/mixin","../../external/layer","../../external/proxy","../../external/requestAnimationFunction"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){a[v]={UI:{circle:{radius:6},arrow:{width:5.5,ratio:2},size:{zoom:2,offset:{x:0,y:0}}},d3:{force:{charge:-200,linkDistance:30,linkStrength:1,gravity:.15,enabled:!1}},state:{mode:"default",selected:void 0}},a[x]={UI:{circle:{radius:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=parseFloat(b),1/0>b&&b>-(1/0)&&(c(b),a.updateGraph())})}},arrow:{width:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=parseFloat(b),1/0>b&&b>-(1/0)&&(c(b),a.updateGraph())})},ratio:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=Math.abs(parseFloat(b)),1/0>b&&(c(b),a.updateGraph())})}},size:{zoom:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=Math.max(H,parseFloat(b)),1/0>b&&(c(b),a.resize())})},offset:{x:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=parseFloat(b),1/0>b&&b>-(1/0)&&(c(b),a.resize())})},y:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=parseFloat(b),1/0>b&&b>-(1/0)&&(c(b),a.resize())})}}}},d3:{force:{charge:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=parseFloat(b),1/0>b&&b>-(1/0)&&(c(b),a.force.charge(b),a.startForce())})},linkDistance:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){if(b=Math.max(0,parseFloat(b)),1/0>b){var d=getComputedStyle(a.svg),e=d.width,f=d.height;c(b),a.force.linkDistance(2e3*b/Math.hypot(parseFloat(e),parseFloat(f))),a.startForce()}})},linkStrength:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=Math.max(0,parseFloat(b)),1/0>b&&(c(b),a.force.linkStrength(b),a.startForce())})},gravity:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=Math.max(0,parseFloat(b)),1/0>b&&(c(b),a.force.gravity(b),a.startForce())})},enabled:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){c(!!b),b?a.startForce():a.force.stop()})}}},state:{mode:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){b=-1!=["default","edit"].indexOf(b)?b:"default",a.setAttribute("mode",b),a.dispatchEvent(new CustomEvent("modechange",{detail:b})),c(b)})},selected:{set:function(a){var b=function(){return a.apply(this,arguments)};return b.toString=function(){return a.toString()},b}(function(b,c){console.log("select",b),isNaN(b)&&(b=void 0);var d=a[B].selectAll("circle.node"),e=d.filter(function(){return b===this.__data__.index}).node();d.each(function(){this!==e&&this.classList.remove("selected")}),e&&void 0!==b?(e.classList.add("selected"),c(b)):(a.config.state.mode="default",c(void 0))})}}},a[y]=t(function(){console.log("dispatch config change"),a.dispatchEvent(new CustomEvent("configchange"))}),a.proxyHandler={},a[D]=t(function(){console.log("dispatch graph change"),a.dispatchEvent(new CustomEvent("graphchange"))}),a[E]=t(function(){var b=a.svg,c=getComputedStyle(b),d=c.width,e=c.height,f=a.config.UI.size.zoom;d=parseFloat(d)/f,e=parseFloat(e)/f,q(b.viewBox.baseVal,{x:-d/2,y:-e/2,width:d,height:e},q.OVERRIDE),a.config.d3.force.linkDistance+=0}),a[F]=t(function(){console.log("draw");var b=a.svg.viewBox.baseVal,c=b.x,d=b.y,e=b.width,f=b.height,g=a.config.UI.size.offset,h=a.config.UI.size.zoom;c=c*h+g.x,d=d*h+g.y,e*=h/G,f*=h/G;var i=a.config.UI.arrow,j=a[A],k=j.circles,l=j.paths;k&&k.attr("transform",function(a){return"translate("+(a.x*e+c)+","+(a.y*f+d)+")"}),l&&l.attr("d",function(a){var b=a.source,g=a.target,h=b.x*e+c,j=b.y*f+d,k=g.x*e+c,l=g.y*f+d,m=h-k,n=j-l,o=Math.hypot(m,n),p=m/o*i.width,q=n/o*i.width;isNaN(p)&&(p=0),isNaN(q)&&(q=0);var r=h-p*i.ratio,s=j-q*i.ratio;return"M"+k+","+l+"L "+r+","+s+"L "+(h+q)+","+(j-p)+"L "+(h-q)+","+(j+p)+"L "+r+","+s})})}function j(a){a[A]={},a[B]=p.select(a.svg);var b=p.layout.force();a[u]=b,b.on("tick",a[F]),b.on("end",a[D]),b.size([G,G])}function k(a){var b=r(a.config.UI.size,{zoom:{translate:function(a){console.log("zoom",a)},duration:280},offset:{x:{translate:function(a){console.log("x",a)}},y:{translate:function(a){console.log("y",a)}}}});a.svg.addEventListener("wheel",function(a){var c=(a.layerX,a.layerY,a.wheelDelta);b.zoom=Math.max(0,b.zoom+c/20)}),PolymerGestures.addEventListener(a.svg,"tap",function(b){console.log("tap"),b.bubbles=!1,b.srcElement===a.svg&&(a[B].selectAll("circle.node").each(function(){this.classList.remove("selected")}),a.config.state.selected=void 0)}),!function(){var c=void 0,d=void 0;PolymerGestures.addEventListener(a.svg,"pinch",function(a){var e=a.scale,f=a.preventTap;f(),void 0!==d&&(b.zoom=Math.max(0,b.zoom+2*(e-d)),clearTimeout(c),c=setTimeout(function(){d=void 0},1e3)),d=e})}(),PolymerGestures.addEventListener(a.svg,"track",function(b){if(console.log("track"),b.bubbles=!1,b.srcElement===a.svg){var c=a.config.UI.size.zoom;a.config.UI.size.offset.x+=b.ddx/c,a.config.UI.size.offset.y+=b.ddy/c}}),!function(){var b=void 0;PolymerGestures.addEventListener(a.svg,"hold",function(c){console.log("hold"),c.bubbles=!1,c.preventTap(),c.srcElement===a.svg&&(b=!1)}),PolymerGestures.addEventListener(a.svg,"holdpulse",function(c){var d=(c.x,c.y,c.srcElement),e=c.holdTime;console.log("holdpulse"),event.bubbles=!1,d===a.svg&&e>800&&!b&&(b=!0,console.log("add node"),a.graph.addNode({}),a.updateGraph())})}()}function l(a,b){console.log("entering circles",b);var c=a.graph,d=a.config.state;b.each(function(){var b=this;console.log("each"),PolymerGestures.addEventListener(this,"tap",function(e){if(console.log("tap on node",b.__data__.index),e.bubbles=!1,"edit"==d.mode){var f=new Map(function(){var a=[],b=!0,d=!1,e=void 0;try{for(var f,g=c.nodes[Symbol.iterator]();!(b=(f=g.next()).done);b=!0){var h=n(f.value,2),i=h[0],j=h[1].index;a.push([j,i])}}catch(k){d=!0,e=k}finally{try{!b&&g["return"]&&g["return"]()}finally{if(d)throw e}}return a}()),g=[f.get(d.selected),f.get(b.__data__.index)];c.hasEdge.apply(c,g)?c.removeEdge.apply(c,g):c.addEdge.apply(c,g),a.updateGraph()}else d.selected=b.__data__.index}),PolymerGestures.addEventListener(this,"trackstart",function(a){a.preventTap(),a.bubbles=!1,b.__data__.fixed=!0}),PolymerGestures.addEventListener(this,"track",function(c){c.bubbles=!1;var d=a.toNodeCoordinates(c.ddx,c.ddy),e=d.x,f=d.y,g=b.__data__;g.px=g.x+=e,g.py=g.y+=f,a.draw()}),PolymerGestures.addEventListener(this,"trackend",function(a){a.bubbles=!1,b.__data__.fixed=!1}),PolymerGestures.addEventListener(this,"hold",function(a){console.log("hold on node"),a.bubbles=!1,a.preventTap(),d.selected=b.__data__.index,d.mode="edit"})})}var m=function(a){return a&&a.__esModule?a["default"]:a},n=function(a,b){if(Array.isArray(a))return a;if(Symbol.iterator in Object(a)){for(var c,d=[],e=a[Symbol.iterator]();!(c=e.next()).done&&(d.push(c.value),!b||d.length!==b););return d}throw new TypeError("Invalid attempt to destructure non-iterable instance")},o=c.Graph,p=m(d),q=m(e),r=m(f),s=m(g),t=m(h),u=Symbol(),v=Symbol(),w=Symbol(),x=Symbol(),y=Symbol(),z=Symbol(),A=Symbol(),B=Symbol(),C=Symbol(),D=Symbol(),E=Symbol(),F=Symbol(),G=1e3,H=.35;b.exports=Object.defineProperties({is:"graphjs-tezcatlipoca",created:function(){i(this)},ready:function(){k(this),j(this),q(this.config,this.config,q.OVERRIDE),this.resize(),addEventListener("polymer-ready",this[E])},attached:function(){addEventListener("resize",this[E])},detached:function(){removeEventListener("resize",this[E])},draw:function(){this[F]()},resize:function(){this[E]()},updateGraph:function(){var a=this;console.log("update graph"),this.graph?!function(){var b=a.graph.nodes,c=function(){var a=[],c=!0,d=!1,e=void 0;try{for(var f,g=b[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=n(f.value,2),i=h[1];a.push(i)}}catch(j){d=!0,e=j}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}return a}(),d=function(){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a.graph.edges[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=g.value,j=i.source,k=i.target;c.push({source:b.get(j),target:b.get(k)})}}catch(l){e=!0,f=l}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}(),e=a.force;e.nodes(c).links(d);var f=a[B],g=f.selectAll("circle.node").data(c),h=f.selectAll("path.edge").data(d);a[A]={circles:g,paths:h},h.enter().append("path").attr("class","edge");var i=g.enter().append("circle").attr("r",a.config.UI.circle.radius).attr("class","node");l(a,i),h.exit().remove(),g.exit().remove(),f.selectAll("circle.node,path.edge").sort(function(a){return("index"in a)-.5});var j=a.config.state;j.selected=j.selected,a.startForce()}():this.graph=new o(!0),this[D]()},toNodeCoordinates:function(a,b){{var c=getComputedStyle(this.svg),d=c.width,e=c.height,f=this.config.UI.size.zoom;this.svg.viewBox.baseVal}return{x:a/parseFloat(d)/f*G,y:b/parseFloat(e)/f*G}},startForce:function(){console.log("start force",this.force.alpha()),this.config.d3.force.enabled?this.force.alpha()||this.force.start():this.draw()}},{svg:{get:function(){return this.$.svg},configurable:!0,enumerable:!0},force:{get:function(){return this[u]},configurable:!0,enumerable:!0},config:{get:function(){return this[w]},set:function(a){q(this[w],a,q.OVERRIDE)},configurable:!0,enumerable:!0},graph:{get:function(){return this[C]},set:function(a){this[C]=a,this.updateGraph()},configurable:!0,enumerable:!0},proxyHandler:{get:function(){return this[z]},set:function(a){this[z]=a,this[w]=r(s(this[v],a),this[x],this[y])},configurable:!0,enumerable:!0}})});